<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Realtime Subtitles</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; }
    button { font-size: 18px; padding: 10px 14px; }
    #status { margin: 12px 0; }
    #subtitle {
      position: fixed; left: 0; right: 0; bottom: 0;
      padding: 18px 16px;
      font-size: 28px;
      line-height: 1.3;
      background: rgba(0,0,0,0.78);
      color: #fff;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <button id="start">Start</button>
  <div id="status">Idle</div>
  <div id="subtitle"></div>

<script>
const statusEl = document.getElementById("status");
const subtitleEl = document.getElementById("subtitle");

document.getElementById("start").onclick = async () => {
  subtitleEl.textContent = "";
  statusEl.textContent = "Getting token...";

  // 1) 从你的后端拿短期 client secret（ephemeral key）
  const t = await fetch("/api/token");
  if (!t.ok) throw new Error(await t.text());
  const token = await t.json();
  const EPHEMERAL_KEY = token.value;

  // 2) WebRTC：建立 RTCPeerConnection
  const pc = new RTCPeerConnection({
  iceServers: [
    { urls: "stun:stun.l.google.com:19302" }
  ]
});

  // 3) 添加麦克风音轨
  statusEl.textContent = "Requesting microphone...";
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  pc.addTrack(stream.getAudioTracks()[0], stream);

  // 4) 建立 DataChannel（收发控制/字幕事件）
  const dc = pc.createDataChannel("oai-events");

  dc.onopen = () => {
    statusEl.textContent = "Listening...";
    // 设置：只输出字幕文本，并给翻译规则
    dc.send(JSON.stringify({
      type: "session.update",
      session: {
        modalities: ["text"],
        instructions:
          "你是同声传译员。输入为英文→翻译成中文；输入为中文→翻译成英文。输出像字幕：每次1-2行，短句，不要解释。"
      }
    }));
  };

  dc.onmessage = (e) => {
    // 不同版本事件字段可能不同：先用“稳妥策略”抓增量
    let evt;
    try { evt = JSON.parse(e.data); } catch { return; }

    // 常见：response.text.delta / response.done 等事件（类型名以官方为准）
    if (evt.type && evt.type.includes("delta")) {
      const chunk = evt.delta ?? evt.text ?? evt?.content?.[0]?.text;
      if (chunk) subtitleEl.textContent += chunk;
    }
    if (evt.type && evt.type.includes("done")) {
      subtitleEl.textContent += "\n";
    }
  };

  // 5) SDP 交换：offer -> OpenAI /v1/realtime/calls -> answer
  statusEl.textContent = "Connecting to Realtime...";
  const offer = await pc.createOffer();
await pc.setLocalDescription(offer);

const resp = await fetch("https://api.openai.com/v1/realtime/calls", {
  ...
});

  statusEl.textContent = "Connected ✅ Talk and watch subtitles below.";
};
</script>
</body>
</html>



